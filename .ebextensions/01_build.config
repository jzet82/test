commands:
    create_post_dir:
        command: "mkdir /opt/elasticbeanstalk/hooks/appdeploy/post"
        ignoreErrors: true
files:
    /etc/nginx/.htpasswd:
        mode: "000755"
        owner: root
        group: root
        content: |
            dev:$apr1$OYV7ov6e$jJj/Wf9LkGPqzpLnH8xZX.
    "/opt/elasticbeanstalk/hooks/appdeploy/post/99_build_app.sh":
        mode: "000755"
        owner: root
        group: root
        content: |
            #!/usr/bin/env bash
            sudo curl -sS https://getcomposer.org/installer | sudo php
            sudo mv composer.phar /var/app/current/php-app
            cd /var/app/current/php-app
            sudo mkdir /root/.composer
            mv auth.json /root/.composer/auth.json
            sudo cp /etc/nginx/.htpasswd /var/app/current/proxy/conf.d/.htpasswd
            export COMPOSER_HOME=/root
            sudo rm -rf /var/app/current/php-app/pub
            sed -i 's/index.php$is_args$args;/index.php$is_args$args;\n     auth_basic "Restricted";\n     auth_basic_user_file \/etc\/nginx\/conf.d\/.htpasswd;\n/' /var/app/current/proxy/conf.d/default.conf
            sudo php composer.phar install --ignore-platform-reqs
            mv /var/app/current/php-app/config.php /var/app/current/php-app/app/etc/config.php
            mv /var/app/current/php-app/env.php /var/app/current/php-app/app/etc/env.php
            sudo chmod -R 777 app/etc/ var/ generated/ pub/media/ pub/static/
            chown -R ec2-user:ec2-user .
            chmod u+x bin/magento